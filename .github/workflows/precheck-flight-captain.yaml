name: Run Captain Shell Script

on:
  repository_dispatch:
    types: [ rke2-release-validation ]
  workflow_dispatch:
    inputs:
      k3s_versions:
        description: |
          'Provide the list of k3s versions (comma separated)
          Ex: v1.34.0-rc1+k3s1,v1.33.4-rc1+k3s1,v1.32.8-rc1+k3s1,v1.31.12-rc1+k3s1'
        required: false
      rke2_versions:
        description: |
          'Provide the list of rke2 versions (comma separated)
          Ex: v1.34.0-rc1+rke2r1,v1.33.4-rc1+rke2r1,v1.32.8-rc1+rke2r1,v1.31.12-rc1+rke2r1'
        required: false
      rke2_lts_versions:
        description: |
          'Provide the list of rke2 lts versions to test prime registry (comma separated)
          Ex: v1.30.14-rc1+rke2r3'
        required: false
      page_size:
        description: 'Page size for API queries'
        required: false
        default: '150'

jobs:
  run-script-job:
    runs-on: ubuntu-latest

    steps:
      - name: Show received data
        run: |
          echo "RKE2 Versions (dispatch): ${{ github.event.client_payload.rke2_versions }}"
          echo "RKE2 Versions (manual): ${{ github.event.inputs.rke2_versions }}"
          echo "Source Repo: ${{ github.event.client_payload.source_repo }}"
          echo "Release URL: ${{ github.event.client_payload.release_url }}"
          echo "Triggered by: ${{ github.event.client_payload.triggered_by }}"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set versions from dispatch or manual input
        id: set_versions
        run: |
          # Get versions from repository dispatch or manual input
          RKE2_VERSIONS="${{ github.event.client_payload.rke2_versions }}${{ github.event.inputs.rke2_versions }}"
          K3S_VERSIONS="${{ github.event.client_payload.k3s_versions }}${{ github.event.inputs.k3s_versions }}"
          RKE2_LTS_VERSIONS="${{ github.event.client_payload.rke2_lts_versions }}${{ github.event.inputs.rke2_lts_versions }}"
          PAGE_SIZE="${{ github.event.inputs.page_size || '150' }}"
          
          echo "rke2_versions=$RKE2_VERSIONS" >> $GITHUB_OUTPUT
          echo "k3s_versions=$K3S_VERSIONS" >> $GITHUB_OUTPUT  
          echo "rke2_lts_versions=$RKE2_LTS_VERSIONS" >> $GITHUB_OUTPUT
          echo "page_size=$PAGE_SIZE" >> $GITHUB_OUTPUT
          
          echo "Final RKE2 Versions: $RKE2_VERSIONS"
          echo "Final K3S Versions: $K3S_VERSIONS"
          echo "Final RKE2 LTS Versions: $RKE2_LTS_VERSIONS"
          echo "Page Size: $PAGE_SIZE"

      - name: Update and install necessary packages
        run: sudo apt-get update && sudo apt-get install -y jq curl skopeo

      - name: Change permissions and make script executable (if needed)
        working-directory: ./scripts
        run: chmod +x ./captain.sh

      - name: Verify K3S versions - run captain shell script
        working-directory: ./scripts
        id: k3s_verify
        if: ${{ steps.set_versions.outputs.k3s_versions != '' }}
        run: ./captain.sh -v "${{ steps.set_versions.outputs.k3s_versions }}" -d -p "${{ steps.set_versions.outputs.page_size }}"
        shell: sh
        continue-on-error: true

      - name: Verify RKE2 versions - run captain shell script
        working-directory: ./scripts
        id: rke2_verify
        if: ${{ steps.set_versions.outputs.rke2_versions != '' }}
        run: ./captain.sh -v "${{ steps.set_versions.outputs.rke2_versions }}" -d -p "${{ steps.set_versions.outputs.page_size }}"
        shell: sh
        continue-on-error: true

      - name: Verify LTS RKE2 versions - run captain shell script
        working-directory: ./scripts
        id: rke2_lts_verify
        if: ${{ steps.set_versions.outputs.rke2_lts_versions != '' }}
        run: ./captain.sh -l "${{ steps.set_versions.outputs.rke2_lts_versions }}" -d
        shell: sh

      - name: Check for previous failures
        if: steps.k3s_verify.outcome == 'failure' || steps.rke2_verify.outcome == 'failure' || steps.rke2_lts_verify.outcome == 'failure'
        run: |
          echo "One or more steps failed, marking job as failed."
          exit 1